<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sarah's Domain - Window System</title>
	<link rel="shortcut icon" href="/assets/favicon.png" />
	<style>
		body {
			background-color: black;
			color: white;
			font-family: sans-serif;
			margin: 0;
			overflow: hidden;
		}

		#canvas {
			background-color: #3f0f0f;
		}
	</style>
</head>

<body onload='s_Resize();s_DrawAll();'>

	<canvas id='canvas' width='256' height='256'></canvas>

	<script>
		var canvas = document.getElementById('canvas');
		var c;

		/* why is this broken */
		var newWindowWindow = {
			x: 16, y: 16, w: 128, height: 64, minw: 128, minh: 64, maxw: 128, maxh: 128, moving: false, scaling: false, drawFunc: (w) => {
				c.shadowColor = '#0007';
				c.shadowBlur = 25;
				c.fillStyle = '#111';
				c.fillRect(w.x, w.y, w.w, w.h);

				c.shadowColor = 'transparent';
				c.shadowBlur = 0;
				c.fillStyle = '#ddd';
				c.textAlign = 'left';
				c.font = '11px sans-serif';
				//c.fillText('Spawn new window', w.x + 4, w.y + 11, w.w - 4);
			}, clickFunc: (e, w) => {
				if (e.buttons == 1) {
					windows.push(Object.create(testWindow));
				}
			}
		};
		var testWindow = {
			x: 64, y: 64, w: 320, h: 240, minw: 320, minh: 240, maxw: 640, maxh: 480, moving: false, scaling: false, drawFunc: (w) => {
				c.shadowColor = '#0007';
				c.shadowBlur = 25;
				c.fillStyle = '#111';
				c.fillRect(w.x, w.y, w.w, w.h);

				c.shadowColor = 'transparent';
				c.shadowBlur = 0;
				c.fillStyle = '#ddd';
				c.textAlign = 'left';
				c.font = '11px sans-serif';
				c.fillText('Welcome to my experimental in-canvas window system!', w.x + 4, w.y + 11, w.w - 4);
				c.fillText('Hold ALT+LMB to move a window or ALT+RMB to scale one.', w.x + 4, w.y + 11 * 2, w.w - 4);
				c.fillText('(Sorry to those of you with window managers that have', w.x + 4, w.y + 11 * 3, w.w - 4);
				c.fillText('controls conflicting with this!)', w.x + 4, w.y + 11 * 4, w.w - 4);
				c.fillText('All windows draw their own decorations as there isn\'t', w.x + 4, w.y + 11 * 5, w.w - 4);
				c.fillText('much of any default decorations besides a border.', w.x + 4, w.y + 11 * 6, w.w - 4);
				c.fillText('There was going to be a "spawn window" button', w.x + 4, w.y + 11 * 7, w.w - 4);
				c.fillText('in the top left corner but for some reason it\'s broken.', w.x + 4, w.y + 11 * 8, w.w - 4);

				/*
				c.strokeStyle = '#ddd';
				c.save();
				c.translate((w.x + w.w - 16 - 4) + 0.5, (w.y + w.h - 16 - 4) + 0.5);
				c.strokeRect(0, 0, 16, 16);

				c.beginPath();
				c.moveTo(0, 0);
				c.lineTo(16, 16);
				c.stroke();
				c.moveTo(16, 0);
				c.lineTo(0, 16);
				c.stroke();
				c.restore();*/
			}, clickFunc: (e, w) => {
				/* this is broken right now */
				if (e.buttons == 1) {
					let x = (w.x + w.w - 16 - 4);
					let y = (w.y + w.h - 16 - 4);
					if (e.clientX > x && e.clientX < x + 16 && e.clientY > y && e.clientY < y + 16) {
						// delete windows[windows.indexOf(w)];
					}
				}
			}
		};
		var windows = [newWindowWindow, testWindow];

		function clamp(value, min, max) { return value = Math.min(max, Math.max(min, value)); }

		function s_MouseButtonEvent(e) {
			if (windows[0] == undefined || windows[0] == null)
				return;

			if (e.altKey) {
				for (let i = 0; i < windows.length; i++) {
					let x = windows[i].x, y = windows[i].y, x2 = windows[i].x + windows[i].w, y2 = windows[i].y + windows[i].h;
					if (e.clientX > x && e.clientX < x2 && e.clientY > y && e.clientY < y2) {
						if (e.buttons == 1) {
							windows[i].moving = true;
						} else if (e.buttons == 2) {
							windows[i].scaling = true;
						}
						break;
					}
				}
			} else {
				for (let i = 0; i < windows.length; i++) {
					let x = windows[i].x, y = windows[i].y, x2 = windows[i].x + windows[i].w, y2 = windows[i].y + windows[i].h;
					if (e.clientX > x && e.clientX < x2 && e.clientY > y && e.clientY < y2) {
						windows[i].clickFunc(e, windows[i]);
						break;
					}
				}
			}

			if (e.buttons == 0) {
				for (let i = 0; i < windows.length; i++) {
					windows[i].moving = false;
					windows[i].scaling = false;
				}
			}

			/* for some reason MouseEvent doesn't have a preventDefault() method */
			return false;
		}

		function s_MouseMoveEvent(e) {
			if (windows[0] == undefined || windows[0] == null)
				return;
			for (let i = 0; i < windows.length; i++) {
				if (windows[i].moving) {
					windows[i].x += e.movementX;
					windows[i].y += e.movementY;
					windows[i].x = clamp(windows[i].x, 1, canvas.width - windows[i].w - 1);
					windows[i].y = clamp(windows[i].y, 1, canvas.height - windows[i].h - 1);
				} else if (windows[i].scaling) {
					windows[i].w += e.movementX;
					windows[i].h += e.movementY;
					windows[i].w = clamp(windows[i].w, windows[i].minw, windows[i].maxw);
					windows[i].h = clamp(windows[i].h, windows[i].minh, windows[i].maxh);
				}
			}
		}

		function s_Resize() {
			/* fullscreen the canvas */
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;

			c = canvas.getContext('2d');
		}

		function s_ResetDrawParms() {
			c.fillStyle = 'black';
			c.strokeStyle = 'black';
			c.shadowColor = 'black';
			c.shadowBlur = 0;
			c.shadowOffsetX = 0;
			c.shadowOffsetY = 0;
		}

		function d_Window() {
			if (windows[0] == undefined || windows[0] == null)
				return;
			for (let i = 0; i < windows.length; i++) {
				windows[i].drawFunc(windows[i]);
				c.strokeStyle = 'white';
				c.save();
				c.translate(0.5, 0.5);
				c.strokeRect(windows[i].x - 1, windows[i].y - 1, windows[i].w + 1, windows[i].h + 1);
				c.restore();
				s_ResetDrawParms();
			}
		}

		function s_DrawAll() {
			c.clearRect(0, 0, canvas.width, canvas.height);
			d_Window();

			s_ResetDrawParms();
			requestAnimationFrame(s_DrawAll);
		}

		canvas.onmousedown = s_MouseButtonEvent;
		canvas.onmouseup = s_MouseButtonEvent;
		canvas.addEventListener('mousemove', s_MouseMoveEvent);
		/* disable context menu */
		canvas.addEventListener('contextmenu', (e) => { e.preventDefault() });
		window.addEventListener('resize', s_Resize);
	</script>

</body>

</html>